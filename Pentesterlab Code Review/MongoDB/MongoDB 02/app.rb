require 'sinatra/base'
require 'digest/md5'
require 'mongo_mapper'

class Exercise < Sinatra::Base

  # ---- Database name helper ----
  def self.db
    'pentesterlab'
  end

  enable :sessions

  helpers do
    alias_method :h, :escape_html
  end

  # ---- MongoDB Model ----
  class User
    include MongoMapper::Document

    key :username, String
    key :password, String
  end

  # ---- Seed value ----
  SEED = "********"

  # ---- Sinatra config ----
  set :bind, '0.0.0.0'
  set :views, File.join(File.dirname(__FILE__), 'views')

  # ---- MongoDB configuration + data seed ----
  configure do
    MongoMapper.connection = Mongo::Connection.new('db', 27017)
    MongoMapper.database   = "exercise"

    # recreate() if $dev

    User.create(
      :username => 'admin',
      :password => ENV['PTLAB_KEY']
    )

    User.create(
      :username => 'test',
      :password => Digest::MD5.hexdigest(SEED + "********" + SEED)
    )

    User.create(
      :username => 'test3',
      :password => Digest::MD5.hexdigest(SEED + "********" + SEED)
    )

    User.create(
      :username => 'test4',
      :password => Digest::MD5.hexdigest(SEED + "********" + SEED)
    )
  end

  # ---- Main route (VULNERABLE) ----
  get '/' do
    MongoMapper.database = "exercise"
    MongoMapper.connection.connect

    @res = []

    if params['search']
      begin
        # âš ï¸ NoSQL Injection vulnerability
        nosql = "this.username=='#{params['search']}' "
        @res = User.all('$where' => nosql)
      rescue Exception => e
        @message = e.to_s
      end
    else
      @res = User.all
    end

    erb :index
  end

end
