<?php
// Redirect to default credentials if no name provided
if (!isset($_GET['name'])) {
    header('Location: /?name=admin&password=admin');
    die();
}

require 'header.php';
?>
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>LDAP 02</title>
</head>
<body>
<div class="row">
  <div class="col-lg-12">
    <h1>LDAP 02</h1>

<?php
// Connect to LDAP server
$ld = ldap_connect('localhost') or die('Could not connect to LDAP server');
ldap_set_option($ld, LDAP_OPT_PROTOCOL_VERSION, 3);
ldap_set_option($ld, LDAP_OPT_REFERRALS, 0);

if ($ld) {
    // Bind as admin to perform searches
    $lb = @ldap_bind($ld, 'cn=admin,dc=pentesterlab,dc=com', 'pentesterlab');

    if ($lb) {
        // Build stored-hash format used in this lab: {MD5}<base64(md5(password))>
        // Note: replicates original behaviour (unsalted MD5 then base64 of raw bytes)
        $pass = '{MD5}' . base64_encode(pack('H*', md5($_GET['password'])));

        // Vulnerable filter construction (unsanitized username)
        $filter = '(&(cn=' . $_GET['name'] . ')(userPassword=' . $pass . '))';

        // Perform the search
        if (!($search = @ldap_search($ld, 'ou=people,dc=pentesterlab,dc=com', $filter))) {
            echo 'Unable to search ldap server<br>';
            echo 'msg: ' . ldap_error($ld) . '<br>';
        } else {
            $number_returned = ldap_count_entries($ld, $search);
            $info = ldap_get_entries($ld, $search);

            if ($info['count'] < 1) {
                // No matching entries -> unauthenticated
                echo 'UNAUTHENTICATED';
            } else {
                // Successfully authenticated
                echo 'AUTHENTICATED as';
                echo ' ' . htmlentities($info[0]['uid'][0]);

                // If uid == admin, show the lab key
                if ($info[0]['uid'][0] == 'admin') {
                    echo '<br/><b>Congratulations! The key for this exercise is ' . htmlentities(getenv('PTLAB_KEY')) . '</b><br/>';
                }
            }
        }
    } else {
        echo 'Failed to bind to LDAP (admin bind failed).';
    }
} else {
    echo 'LDAP connection not available.';
}
?>

  </div>
</div>
</body>
</html>
