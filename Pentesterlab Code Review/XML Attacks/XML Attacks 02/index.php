<?php
if (!isset($_GET["name"])) {
    header("Location: /?name=hacker&password=pentesterlab");
    die();
}

$x = "<data>
        <users>
            <user>
                <name>hacker</name>
                <message>Hello hacker</message>
                <password>pentesterlab</password>
            </user>
            <user>
                <name>admin</name>
                <message>Hello admin</message>
                <password>s3cr3ts3cr3tP4ssw0rdP4ssw0rd</password>
            </user>
        </users>
      </data>";

require "header.php";
?>

<div class="row">
    <div class="col-lg-12">
        <h1>XML 02</h1>
        <p>
            The objective of this exercise is to find and exploit the XPath injection
            in this page to become admin.
        </p>

        <h3>
        <?php
        $xml = simplexml_load_string($x);

        $xpath = "users/user/name[.='".$_GET['name']."']/parent::*/password[.='".$_GET['password']."']/parent::*/message";
        // $xpath = "users/user[name/text()='".$_GET['name']."' and password/text()='".$_GET['password']."']/parent::*/message";

        $res = $xml->xpath($xpath);

        while (list(, $node) = each($res)) {
            echo "<h3>".$node."</h3>";

            if ($node == 'Hello admin') {
                echo "<span class='text text-success'>
                        <p class='lead'>
                            The key for this exercise is <b>"
                            . htmlentities(getenv("PTLAB_KEY")) .
                        "</b>
                        </p>
                      </span>";
            }
        }
        ?>
        </h3>
    </div>
</div>
